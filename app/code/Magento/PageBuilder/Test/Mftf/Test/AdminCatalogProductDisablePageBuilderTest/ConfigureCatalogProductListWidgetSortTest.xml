<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
  * Copyright Â© Magento, Inc. All rights reserved.
  * See COPYING.txt for license details.
  */
-->
<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="ConfigureCatalogProductListWidgetSortTest">
        <annotations>
            <stories value="Configure catalog product list widget sort order in backend and validate it does match in the frontend"/>
            <title value="Configure catalog product list widget sort order in backend and validate it does match in the frontend "/>
            <description value="Configure catalog product list widget sort order in backend and validate it does match in the frontend"/>
            <severity value="MAJOR"/>
            <testCaseId value="AC-5684"/>
            <group value="pagebuilder_disabled"/>
        </annotations>
        <before>
            <actionGroup ref="AdminLoginActionGroup" stepKey="loginAsAdmin"/>
        </before>
        <after>
            <actionGroup ref="AdminOpenCreateNewCMSPageActionGroup" stepKey="navigateToPageToDeletePage"/>
            <actionGroup ref="DeletePageByUrlKeyActionGroup" stepKey="deleteDisabledPage">
                <argument name="UrlKey" value="test-cms-page"/>
            </actionGroup>
            <deleteData createDataKey="createCategory" stepKey="deleteCategory"/>
            <deleteData createDataKey="createSimpleProduct1" stepKey="deleteSimpleProduct1"/>
            <deleteData createDataKey="createSimpleProduct2" stepKey="deleteSimpleProduct2"/>
            <deleteData createDataKey="createSimpleProduct3" stepKey="deleteSimpleProduct3"/>
            <actionGroup ref="AdminLogoutActionGroup" stepKey="logoutOfAdmin"/>
        </after>
        <!--Step 1 & 2: create subcategory -->
        <createData entity="SimpleSubCategory" stepKey="createCategory"/>
        <!--Step 3: create 3 simple products assigned to category -->
        <createData entity="_defaultProduct" stepKey="createSimpleProduct1">
            <requiredEntity createDataKey="createCategory"/>
        </createData>
        <createData entity="_defaultProduct" stepKey="createSimpleProduct2">
            <requiredEntity createDataKey="createCategory"/>
        </createData>
        <createData entity="_defaultProduct" stepKey="createSimpleProduct3">
            <requiredEntity createDataKey="createCategory"/>
        </createData>
        <!--Step 4: Navigate to Category-->
        <actionGroup ref="AdminNavigateMenuActionGroup" stepKey="navigateToCategoriesPage">
            <argument name="menuUiId" value="{{AdminMenuCatalog.dataUiId}}"/>
            <argument name="submenuUiId" value="{{AdminMenuCatalogCategories.dataUiId}}"/>
        </actionGroup>
        <actionGroup ref="AdminCategoriesOpenCategoryActionGroup" stepKey="openCategory">
            <argument name="category" value="$$createCategory$$"/>
        </actionGroup>
        <scrollTo selector="{{AdminCategoryBasicFieldSection.expand_collapse_section('closed','Products in Category')}}" stepKey="scrollToProductsInCategorySectionForIndexing"/>
        <!--  Reset the indexes Expanding the Products In category Section -->
        <conditionalClick selector="{{AdminCategoryBasicFieldSection.expand_collapse_section('closed','Products in Category')}}" dependentSelector="{{AdminCategoryBasicFieldSection.expand_collapse_section('closed','Products in Category')}}" visible="true" stepKey="expandProductsInCategorySectionForIndexing"/>
        <!-- Step 5, 6 and 7 Set the positions for the products -->
        <click selector="{{AdminCategoryBasicFieldSection.moveProductToFirstIndex('$$createSimpleProduct1.name$$')}}" stepKey="movefirstProdToFirstIndex"/>
        <wait time="1" stepKey="waitForProd1ToShuffleToFirstIndex"/>
        <click selector="{{AdminCategoryBasicFieldSection.moveProductToLastIndex('$$createSimpleProduct3.name$$')}}" stepKey="movefirstProdToLastIndex"/>
        <wait time="1" stepKey="waitForProd3ToShuffleToLastIndex"/>

        <!-- Step 8 Save the category -->
        <click selector="{{AdminCategoryBasicFieldSection.saveCategory}}" stepKey="saveTheCategory"/>
        <see selector="{{AdminMessagesSection.success}}" userInput="You saved the category." stepKey="seeSuccessMessageForSavingCategory"/>
        <magentoCLI stepKey="reindexPostSettingTheIndexAscending" command="indexer:reindex"/>
        <magentoCLI stepKey="flushCachePostSettingTheIndexAscending" command="cache:flush"/>
        <!-- Step 9 Navigate to the CMS page and Create a new Page -->
        <actionGroup ref="AdminOpenCreateNewCMSPageActionGroup" stepKey="navigateToPage"/>
        <fillField selector="{{CmsNewPagePageBasicFieldsSection.pageTitle}}" userInput="{{_defaultCmsPage.title}}" stepKey="fillFieldTitle"/>
        <click selector="{{CmsNewPagePageContentSection.header}}" stepKey="clickContentTab" />
        <actionGroup ref="AdminInsertWidgetToCmsPageContentActionGroup" stepKey="insertWidgetToCmsPageContent">
            <argument name="widgetType" value="Catalog Products List"/>
        </actionGroup>
        <waitForPageLoad stepKey="waitForPageLoadToSetTheRules"/>
        <selectOption selector="{{AdminNewWidgetSection.displayPageControl}}" userInput="No" stepKey="selectDisplayPageControl"/>
        <click selector="{{AdminNewWidgetSection.addNewCondition}}" stepKey="clickAddNewCondition"/>
        <selectOption selector="{{AdminNewWidgetSection.selectCondition}}" userInput="Magento\CatalogWidget\Model\Rule\Condition\Product|category_ids" stepKey="selectCondition"/>
        <waitForElement selector="{{AdminNewWidgetSection.ruleParameter}}" stepKey="waitRuleParameter"/>
        <click selector="{{AdminNewWidgetSection.ruleParameter}}" stepKey="clickRuleParameter"/>
        <click selector="{{AdminNewWidgetSection.openChooser}}" stepKey="clickChooser"/>
        <waitForPageLoad stepKey="waitForAjaxLoad"/>
        <click selector="{{AdminCategorySidebarTreeSection.categoryInTree('$$createCategory.name$$')}}" stepKey="clickCategoryToEditInitial"/>
        <click selector="{{AdminNewWidgetSection.applyParameter}}" stepKey="clickApplyRuleParameter"/>
        <waitForPageLoad stepKey="waitForPageToLoadPostSavingTheRules"/>
        <click selector="{{AdminNewWidgetSection.btnInsertWidget}}" stepKey="clickInsertWidgetButton"/>
        <waitForPageLoad stepKey="waitForPageToLoadPostInsertingTheWidget"/>
        <click selector="{{CmsNewPagePageActionsSection.savePageBtn}}" stepKey="clickSavePage"/>
        <waitForPageLoad stepKey="waitForPageLoadPostSavingThePage"/>
        <see userInput="You saved the page." stepKey="seeSuccessMessagePostSavingThePage"/>
        <!-- Step 10 Verify the order of the page in the Storefront -->
        <actionGroup ref="StorefrontNavigateToCategoryUrlActionGroup" stepKey="openCategoryPage">
            <argument name="categoryUrl" value="$$createCategory.custom_attributes[url_key]$$"/>
        </actionGroup>
        <!-- Should see all three products in category in sorted order-->
        <seeElement selector="{{StorefrontCategoryMainSection.productListInCategoryStorefront('1','$$createSimpleProduct1.name$$')}}" stepKey="seeProduct1InPosition1"/>
        <seeElement selector="{{StorefrontCategoryMainSection.productListInCategoryStorefront('2','$$createSimpleProduct2.name$$')}}" stepKey="seeProduct2InPosition2"/>
        <seeElement selector="{{StorefrontCategoryMainSection.productListInCategoryStorefront('3','$$createSimpleProduct3.name$$')}}" stepKey="seeProduct3InPosition3"/>
        <!-- Reset the indexes Navigate to Category-->
        <moveBack stepKey="moveBackToAdminPage"/>
        <actionGroup ref="AdminNavigateMenuActionGroup" stepKey="navigateToCategoriesPageToResetTheIndexes">
            <argument name="menuUiId" value="{{AdminMenuCatalog.dataUiId}}"/>
            <argument name="submenuUiId" value="{{AdminMenuCatalogCategories.dataUiId}}"/>
        </actionGroup>
        <actionGroup ref="AdminCategoriesOpenCategoryActionGroup" stepKey="openCategoryToResetTheIndexes">
            <argument name="category" value="$$createCategory$$"/>
        </actionGroup>
        <!--  Reset the indexes Expanding the Products In category Section -->
        <scrollTo selector="{{AdminCategoryBasicFieldSection.expand_collapse_section('closed','Products in Category')}}" stepKey="scrollToProductsInCategorySectionForResetIndex"/>
        <!--  Reset the indexes Expanding the Products In category Section -->
        <conditionalClick selector="{{AdminCategoryBasicFieldSection.expand_collapse_section('closed','Products in Category')}}" dependentSelector="{{AdminCategoryBasicFieldSection.expand_collapse_section('closed','Products in Category')}}" visible="true" stepKey="expandProductsInCategorySectionForResettingTheIndex"/>
        <!--  Reset the indexes and Set the positions for the products -->
        <click selector="{{AdminCategoryBasicFieldSection.moveProductToFirstIndex('$$createSimpleProduct3.name$$')}}" stepKey="moveLastProdToFirstIndex"/>
        <wait time="1" stepKey="waitForProd1ToShuffleToLastIndex"/>
        <click selector="{{AdminCategoryBasicFieldSection.moveProductToLastIndex('$$createSimpleProduct1.name$$')}}" stepKey="moveFirstProdToLastIndex"/>
        <wait time="1" stepKey="waitForProd3ToShuffleToFirstIndex"/>
        <!--  Reset the indexes Save the category -->
        <click selector="{{AdminCategoryBasicFieldSection.saveCategory}}" stepKey="saveTheCategoryToResetTheIndexes1"/>
        <see selector="{{AdminMessagesSection.success}}" userInput="You saved the category." stepKey="seeSuccessMessageForSavingCategoryPostResetTheIndex"/>
        <magentoCLI stepKey="reindexPostSettingTheIndexDescending" command="indexer:reindex"/>
        <magentoCLI stepKey="flushCachePostSettingTheIndexDescending" command="cache:flush"/>
        <!--  Reset the indexes Verify the order of the page in the Storefront -->
        <actionGroup ref="StorefrontNavigateToCategoryUrlActionGroup" stepKey="openCategoryPageOnStorefrontToResetTheIndexes">
            <argument name="categoryUrl" value="$$createCategory.custom_attributes[url_key]$$"/>
        </actionGroup>
        <!-- Should see all three products in category in sorted order according to new indexes -->
        <seeElement selector="{{StorefrontCategoryMainSection.productListInCategoryStorefront('3','$$createSimpleProduct1.name$$')}}" stepKey="seeProduct1InPosition3"/>
        <seeElement selector="{{StorefrontCategoryMainSection.productListInCategoryStorefront('2','$$createSimpleProduct2.name$$')}}" stepKey="seeProduct2InPosition2AsItIs"/>
        <seeElement selector="{{StorefrontCategoryMainSection.productListInCategoryStorefront('1','$$createSimpleProduct3.name$$')}}" stepKey="seeProduct3InPosition1"/>
        <moveBack stepKey="moveBackToAdminPageToDeletePage"/>
    </test>
</tests>
